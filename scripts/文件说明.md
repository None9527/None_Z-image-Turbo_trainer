# SVD LoRA 提取工具说明 (Extract LoRA SVD)

## 简介
这是一个用于通过奇异值分解 (SVD) 从两个模型（Base 和 Turbo）的权重差中提取 LoRA 模型的脚本。
它可以帮助你从同一个架构的加速模型（如 Turbo/Lightning）和原始模型中提取出差异部分作为 LoRA，从而在其他基础模型上复现加速效果。

## 文件位置
`scripts/extract_lora_svd.py`

## 依赖
请确保你的环境已安装以下库：
- `torch`
- `diffusers`
- `safetensors`

## 使用方法

### 基本命令
```bash
python scripts/extract_lora_svd.py \
  --base_model "path/to/Base_Model" \
  --turbo_model "path/to/Turbo_Model" \
  --output_path "path/to/output_lora.safetensors"
```

### 参数说明

| 参数 | 类型 | 必选 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| `--base_model` | str | 是 | - | 基础模型路径（通常是原始未加速的模型）。 |
| `--turbo_model` | str | 是 | - | 目标/加速模型路径（如 Turbo, LCM, Lightning 等）。 |
| `--output_path` | str | 是 | - | 输出 LoRA 文件保存路径 (.safetensors)。 |
| `--rank` | int | 否 | 64 | SVD 分解的秩 (Rank)。Rank 越高还原度越高，文件越大。 |
| `--device` | str | 否 | cuda | 运行设备 ('cuda' 或 'cpu')。 |
| `--subfolder` | str | 否 | transformer | 模型子文件夹名称。Flux/SD3 通常用 `transformer`，SDXL/SD1.5 可能需要配合 `--use_unet`。 |
| `--use_unet` | flag | 否 | False | 如果是 SD1.5/SDXL 等使用 UNet 结构的模型，请添加此标记。 |

### 示例

**提取 Flux/SD3 Turbo LoRA (Transformer 结构):**
```bash
python scripts/extract_lora_svd.py \
  --base_model "./models/Flux_Base" \
  --turbo_model "./models/Flux_Turbo" \
  --output_path "./loras/flux_turbo_accel.safetensors" \
  --rank 128
```

**提取 SDXL Turbo LoRA (UNet 结构):**
```bash
python scripts/extract_lora_svd.py \
  --base_model "./models/SDXL_Base" \
  --turbo_model "./models/SDXL_Turbo" \
  --output_path "./loras/sdxl_turbo_accel.safetensors" \
  --subfolder "unet" \
  --use_unet \
  --rank 64
```

## 注意事项
1. **内存消耗**: SVD 计算（尤其是大 Rank）需要较多显存/内存。如果 OOM，请尝试降低 `--device` 为 `cpu`（速度较慢）。
2. **模型结构**: 两个模型必须具有完全相同的网络结构（Layer 名称和 Shape 必须一致），否则无法计算差值。
3. **效果**: 提取效果取决于 Rank 大小。对于风格迁移或加速 LoRA，Rank=64 或 128 通常是不错的平衡点。
