# Z-Image Turbo Trainer

å¤šæ¨¡å‹åŠ é€Ÿ LoRA è®­ç»ƒæ¡†æ¶ï¼Œæ”¯æŒ Z-Imageã€LongCat-Image ç­‰æ¨¡å‹çš„ Turbo/åŠ é€Ÿè®­ç»ƒã€‚

## å¿«é€Ÿå¼€å§‹

### å®‰è£…

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å®‰è£…é¡¹ç›®
pip install -e .
```

### è¿è¡Œè®­ç»ƒ

```bash
# Z-Image è®­ç»ƒ
python scripts/train_acrf.py --config config/acrf_config.toml

# é€šç”¨åŠ é€Ÿ LoRA è®­ç»ƒï¼ˆæ”¯æŒå¤šæ¨¡å‹ï¼‰
python scripts/train_turbo.py --model_type longcat --dit /path/to/model --config config/longcat_turbo_config.toml
```

## é¡¹ç›®ç»“æ„

```
None_Z-image-Turbo_trainer/
â”œâ”€â”€ config/                          # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ acrf_config.toml             # AC-RF è®­ç»ƒé…ç½®
â”‚   â”œâ”€â”€ style_transfer_config.toml   # é£æ ¼è¿ç§»é…ç½®
â”‚   â”œâ”€â”€ frequency_aware_config.toml  # é¢‘åŸŸæ„ŸçŸ¥é…ç½®
â”‚   â””â”€â”€ longcat_turbo_config.toml    # LongCat åŠ é€Ÿè®­ç»ƒé…ç½®
â”‚
â”œâ”€â”€ scripts/                         # è®­ç»ƒè„šæœ¬
â”‚   â”œâ”€â”€ train_acrf.py                # AC-RF è®­ç»ƒï¼ˆZ-Image ä¸“ç”¨ï¼‰
â”‚   â”œâ”€â”€ train_turbo.py               # é€šç”¨åŠ é€Ÿ LoRA è®­ç»ƒ
â”‚   â”œâ”€â”€ train_style_transfer.py      # é£æ ¼è¿ç§»è®­ç»ƒ
â”‚   â”œâ”€â”€ train_frequency_aware.py     # é¢‘åŸŸæ„ŸçŸ¥è®­ç»ƒ
â”‚   â””â”€â”€ download_model.py            # æ¨¡å‹ä¸‹è½½å·¥å…·
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ models/                      # ğŸ†• æ¨¡å‹é€‚é…å™¨ï¼ˆæ¨¡å—åŒ–é‡æ„ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py              # ä¸»å…¥å£ï¼Œå¯¼å‡ºæ‰€æœ‰é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ base.py                  # é€‚é…å™¨æŠ½è±¡åŸºç±»
â”‚   â”‚   â”œâ”€â”€ registry.py              # é€‚é…å™¨æ³¨å†Œè¡¨
â”‚   â”‚   â”œâ”€â”€ zimage/                  # Z-Image æ¨¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ adapter.py           # Z-Image é€‚é…å™¨
â”‚   â”‚   â””â”€â”€ longcat/                 # LongCat-Image æ¨¡å‹
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ adapter.py           # LongCat é€‚é…å™¨
â”‚   â”‚
â”‚   â””â”€â”€ zimage_trainer/              # è®­ç»ƒæ ¸å¿ƒæ¨¡å—
â”‚       â”œâ”€â”€ dataset/                 # æ•°æ®é›†å¤„ç†
â”‚       â”‚   â””â”€â”€ dataloader.py        # æ•°æ®åŠ è½½å™¨ + SPDA
â”‚       â”‚
â”‚       â”œâ”€â”€ losses/                  # æŸå¤±å‡½æ•°
â”‚       â”‚   â”œâ”€â”€ frequency_aware_loss.py
â”‚       â”‚   â””â”€â”€ style_structure_loss.py
â”‚       â”‚
â”‚       â”œâ”€â”€ networks/                # ç½‘ç»œæ¨¡å—
â”‚       â”‚   â””â”€â”€ lora.py              # LoRA å®ç°
â”‚       â”‚
â”‚       â”œâ”€â”€ utils/                   # å·¥å…·å‡½æ•°
â”‚       â”‚   â”œâ”€â”€ snr_utils.py         # SNR åŠ æƒ
â”‚       â”‚   â”œâ”€â”€ memory_optimizer.py  # å†…å­˜ä¼˜åŒ–
â”‚       â”‚   â””â”€â”€ hardware_detector.py # ç¡¬ä»¶æ£€æµ‹
â”‚       â”‚
â”‚       â”œâ”€â”€ acrf_trainer.py          # AC-RF è®­ç»ƒå™¨
â”‚       â”œâ”€â”€ cache_latents.py         # Latent ç¼“å­˜
â”‚       â””â”€â”€ cache_text_encoder.py    # Text Encoder ç¼“å­˜
â”‚
â”œâ”€â”€ webui-vue/                       # Web UI
â”‚   â”œâ”€â”€ api/                         # FastAPI åç«¯
â”‚   â”‚   â”œâ”€â”€ core/config.py           # é…ç½®ä¸­å¿ƒ
â”‚   â”‚   â””â”€â”€ routers/                 # API è·¯ç”±
â”‚   â””â”€â”€ src/                         # Vue å‰ç«¯
â”‚
â”œâ”€â”€ env.example                      # ç¯å¢ƒå˜é‡é…ç½®æ¨¡æ¿
â””â”€â”€ requirements.txt                 # ä¾èµ–
```

## æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

### æ¨¡å‹é€‚é…å™¨æ¶æ„ (`src/models/`)

æ¨¡å—åŒ–è®¾è®¡ï¼Œæ¯ä¸ªæ¨¡å‹ä¸€ä¸ªç‹¬ç«‹ç›®å½•ï¼š

```
src/models/
â”œâ”€â”€ __init__.py          # ä¸»å…¥å£
â”œâ”€â”€ base.py              # ModelAdapter æŠ½è±¡åŸºç±»
â”œâ”€â”€ registry.py          # æ³¨å†Œè¡¨ + è‡ªåŠ¨æ£€æµ‹
â”œâ”€â”€ zimage/              # Z-Image æ¨¡å‹
â”‚   â””â”€â”€ adapter.py       # ZImageAdapter
â””â”€â”€ longcat/             # LongCat æ¨¡å‹
    â””â”€â”€ adapter.py       # LongCatAdapter
```

**ä½¿ç”¨æ–¹æ³•**ï¼š

```python
from models import get_adapter, list_adapters

# è·å–é€‚é…å™¨
adapter = get_adapter("zimage")  # æˆ– "longcat"

# åˆ—å‡ºæ‰€æœ‰æ”¯æŒçš„æ¨¡å‹
print(list_adapters())  # ['zimage', 'longcat']

# åŠ è½½æ¨¡å‹
transformer = adapter.load_transformer("/path/to/model")

# è·å– LoRA ç›®æ ‡æ¨¡å—
target_modules = adapter.get_lora_target_modules()
```

**æ”¯æŒçš„æ¨¡å‹**ï¼š
- âœ… Z-Image (Turbo) - 10 æ­¥åŠ é€Ÿ
- âœ… LongCat-Image - åŸºäº FLUX æ¶æ„
- ğŸ”œ FLUX - è®¡åˆ’æ”¯æŒ
- ğŸ”œ SD3 - è®¡åˆ’æ”¯æŒ

**æ·»åŠ æ–°æ¨¡å‹**ï¼š
1. åœ¨ `src/models/` ä¸‹åˆ›å»ºæ–°ç›®å½•ï¼Œå¦‚ `flux/`
2. å®ç° `adapter.py`ï¼Œç»§æ‰¿ `ModelAdapter`
3. ä½¿ç”¨ `@register_adapter("flux")` è£…é¥°å™¨æ³¨å†Œ
4. åœ¨ `src/models/__init__.py` ä¸­å¯¼å‡º

### è®­ç»ƒè„šæœ¬

| è„šæœ¬ | è¯´æ˜ |
|------|------|
| `train_acrf.py` | AC-RF è®­ç»ƒï¼ŒZ-Image ä¸“ç”¨ï¼ŒåŠŸèƒ½æœ€å®Œæ•´ |
| `train_turbo.py` | ğŸ†• é€šç”¨åŠ é€Ÿè®­ç»ƒï¼Œæ”¯æŒå¤šæ¨¡å‹ |
| `train_style_transfer.py` | é£æ ¼è¿ç§»è®­ç»ƒ |

### æŸå¤±å‡½æ•°

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `frequency_aware_loss.py` | é¢‘åŸŸæ„ŸçŸ¥æŸå¤±ï¼ˆé«˜é¢‘å¢å¼º + ä½é¢‘é”å®šï¼‰ |
| `style_structure_loss.py` | é£æ ¼ç»“æ„æŸå¤±ï¼ˆSSIM + å…‰å½± + è‰²è°ƒï¼‰ |

## ç¯å¢ƒå˜é‡é…ç½®

å¤åˆ¶ `env.example` ä¸º `.env`ï¼Œé…ç½®æ¨¡å‹è·¯å¾„ï¼š

```bash
# Z-Image æ¨¡å‹
MODEL_PATH=./zimage_models
VAE_PATH=
TEXT_ENCODER_PATH=
TRANSFORMER_PATH=

# LongCat æ¨¡å‹
LONGCAT_MODEL_PATH=./longcat_models
LONGCAT_VAE_PATH=
LONGCAT_TEXT_ENCODER_PATH=
LONGCAT_TRANSFORMER_PATH=

# LongCat æºç è·¯å¾„ï¼ˆç”¨äºå¯¼å…¥ï¼‰
LONGCAT_SOURCE_PATH=D:/AI/LongCat-Image
```

## é…ç½®è¯´æ˜

### é€šç”¨åŠ é€Ÿé…ç½® (`longcat_turbo_config.toml`)

```toml
[turbo]
turbo_steps = 10          # ç›®æ ‡åŠ é€Ÿæ­¥æ•°
use_anchor = true         # é”šç‚¹é‡‡æ ·
jitter_scale = 0.02       # æŠ–åŠ¨å¹…åº¦

[lora]
network_dim = 32          # LoRA rank
use_peft = true           # ä½¿ç”¨ PEFT åº“

[training]
snr_gamma = 5.0           # Min-SNR åŠ æƒ
```

## æŠ€æœ¯æ ˆ

- **è®­ç»ƒæ¡†æ¶**: PyTorch + Accelerate
- **æ¨¡å‹åº“**: Diffusers, Transformers
- **LoRA**: è‡ªå®šä¹‰å®ç° / PEFT
- **Web UI**: FastAPI + Vue 3 + Element Plus

## ç¯å¢ƒè¦æ±‚

- Python 3.10+
- PyTorch 2.0+
- CUDA 11.8+ (æ¨è)
- 16GB+ VRAM

## æ³¨æ„äº‹é¡¹

1. æœ¬é¡¹ç›®ç”± AI ç”Ÿæˆï¼Œè¯·åœ¨å®é™…ç¯å¢ƒä¸­æµ‹è¯•éªŒè¯
2. åŠ é€Ÿ LoRA è®­ç»ƒæ•ˆæœä¾èµ–æ•°æ®é›†è´¨é‡
3. LongCat é€‚é…å™¨éœ€è¦ LongCat-Image æºç ï¼Œè·¯å¾„é€šè¿‡ `LONGCAT_SOURCE_PATH` ç¯å¢ƒå˜é‡é…ç½®
